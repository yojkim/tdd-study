## 31. 리팩토링
   
### 리팩토링 의미의 차이
- 일반적인 리팩토링은 어떠한 경우에도 프로그램의 의미론을 변경해서는 안됨
- TDD에서는 테스트의 통과 여부만 신경쓰므로 상수를 변수로 바꾸는 등의 과정도 리팩토링이라고 칭함
- 관측상의 동치성이 성립되려면 충분한 테스트가 필요함  
  => 충분한 테스트란 현재 테스트의 리팩토링이 추측 가능한 모든 테스트에 관한 리팩토링과 동일한 것으로 여겨질 수 있는 상태

### 차이점 일치시키기
- 비슷해 보이는 두 코드 조각을 합치려면 두 코드를 단계적으로 닮아가게끔 수정할 것  
  => 반복문의 구조, 조건문에 의해 나눠지는 두 분기, 두 클래스가 비슷할 경우 동일하게 만들고 중복을 제거
- 상위 클래스의 내용과 하위 클래스의 내용이 동일할 경우 하위 클래스에 대한 참조를 상위 클래스로 바꾸는 것도 리팩토링

### 변화 격리하기
- 객체나 메서드의 일부만 바꿀 필요가 있는 경우, 먼저 바꿀 부분을 격리할 것
- 변화를 격리할 경우, 고려되는 외부 요인들로부터 자유로워질 수 있기 때문에 코드 수정에 용이함
- 메서드 추출하기, 객체 추출하기, 메서드 객체 등의 방법이 있음

### 데이터 이주시키기
- 데이터의 표현 양식을 변경하려면 일시적으로 데이터를 중복시킴
- 내부의 표현 양식을 변경한 후 외부 인터페이스를 변화시키며 아래와 같은 방법을 따름  
  1. 새로운 포맷의 인스턴스 변수를 추가
  2. 기존 포맷의 인스턴스 세팅 부분 모두에 새로운 인스턴스 변수 세팅을 추가
  3. 기존 변수를 사용하는 모든 곳에서 새 변수를 사용하게 변경
  4. 기존 포맷을 제거
  5. 새 포맷에 맞게 외부 인터페이스를 변경
- API를 변화시키고 싶을 경우 다음과 같은 방법을 따름  
  1. 새 포맷으로 인자를 하나 추가
  2. 새 포맷 인자에서 이전 포맷의 내부적 표현양식으로 번역
  3. 이전 포맷 인자를 삭제
  4. 이전 포맷을 사용하는 것들을 새로운 포맷으로 바꿈
  5. 이전 포맷을 삭제

### 메서드 추출하기
- 길고 복잡한 메서드를 읽기 쉽게 만들고 싶을 때 긴 메서드의 일부분을 별도의 메서드로 분리하여 호출하도록 설계
- 메서드 추출하기는 복잡한 원자적 리팩토링의 한 가지로서 다음 과정을 따름  
  1. 기존 메서드에서 분리할 수 있을 만한 부분을 찾아냄  
   => 일반적으로 반복문 내부의 코드 또는 그 자체나 조건문들의 가지들이 후보가 됨
  2. 추출할 영역의 외부에서 선언된 임시 변수에 대해 할당하는 문장이 있는지 확인
  3. 추출할 코드를 복사해서 새로운 코드에 붙이기
  4. 원래 메서드에서 사용하던 것이 새로운 메서드에도 쓰인다면 새로운 메서드의 매개변수로 추가
  5. 기존 메서드에서 새 메서드를 호출

### 메서드 인라인
- 메서드를 작은 조각으로 나누는 것은 때때로 정도가 지나칠 수 있기에 새로운 추출 방법을 도입
- 메서드를 호출하는 부분을 호출될 메서드의 본문으로 교체하며 방법은 아래와 같음  
  1. 메서드를 복사
  2. 메서드 호출부를 지우고 복사한 코드를 붙임
  3. 모든 형식 매개변수를 실제 매개변수로 변경

### 인터페이스 추출하기
- 오퍼레이션에 대한 두 번째 구현을 추가하려면 아래의 방법으로 공통되는 오퍼레이션을 담고 있는 인터페이스를 만들 것  
  1. 인터페이스를 선언  
   => 단, 인터페이스의 이름이 기존과 겹칠 경우 기존 클래스의 이름을 변경해줄 것
  2. 기존 클래스가 인터페이스를 구현하도록 설계
  3. 필요한 메서드를 인터페이스에 추가
  4. 가능한 모든 곳의 타입 선언부에서 클래스 이름 대신 인터페이스 이름을 사용하도록 변경

### 메서드 옮기기
- 메서드가 원래 있어야할 장소로 옮기려면 아래와 같이 어울리는 클래스에 메서드를 추가해주고 호출할 것  
  1. 메서드를 복사
  2. 원하는 클래스에 붙이고 이름을 적절히 지어준 다음 컴파일
  3. 원래 객체가 메서드 내부에서 참조된다면 원래 객체를 새 메서드의 매개변수로 추가  
   => 원래 객체의 필드들이 참조되고 있다면 그것들도 추가해야하지만 원래 것이 갱신된다면 포기할 것
  4. 원래 메서드의 본체를 지우고 새 메서드를 호출하는 코드로 채움
- 세 가지의 훌륭한 속성을 가지고 있음  
  1. 코드에 대한 깊은 이해가 없더라도 언제 이 리팩토링이 필요한지 쉽게 알아낼 수 있음
  2. 절차가 빠르고 안전함
  3. 결과가 종종 새로운 사실을 알려주기도 함
- 일부분만 옮기고 싶을 경우 일단 메서드를 추출한 다음 옮기고 원래 있던 추출된 부분을 다시 합치면 됨

### 메서드 객체
- 여러 개의 매개변수와 지역 변수를 갖는 복잡한 메서드를 표한하고 싶을 때 아래의 방법으로 메서드를 꺼내서 객체로 만들 것  
  1. 메서드와 같은 매개변수를 갖는 객체를 설계
  2. 메서드의 지역 변수를 객체의 인스턴스 변수로 지정
  3. 원래 메서드와 동일한 내용을 갖는 **run()** 이라는 이름의 메서드를 설계
  4. 원래 메서드에서는 새로 만들어진 클래스의 인스턴스를 생성하는 **run()** 을 호출
- 시스템에 완전히 새로운 로직을 추가하고 싶을 때 유용함
- 메서드 추출하기를 적용할 수 없는 코드를 간결하게 만들기 위한 용도로 적합

#### 매개변수 추가
- 메서드에 매개변수를 추가하고 싶을 때 아래의 방법으로 추가  
  1. 메서드가 인터페이스에 선언되어 있다면 일단 인터페이스에 매개변수를 추가
  2. 매개변수를 추가
  3. 컴파일 에러를 통해 수정할 부분을 고침
- 새로운 상황을 제대로 완수하기 위해 더 많은 정보가 필요할 경우 사용
- 데이터의 표현을 다르게 변경하고 싶을 때 작업의 일부로 사용하기도 함

### 메서드 매개변수를 생성자 매개변수로 바꾸기
- 하나 이상의 메서드의 매개변수를 생성자로 옮기기 위해 아래의 방법을 사용  
  1. 생성자에 매개변수를 추가
  2. 매개변수와 같은 이름을 갖는 인스턴스 변수를 추가
  3. 생성자에서 인스턴스 변수의 값을 설정
  4. 매개변수 앞에 **this.** 추가
  5. 매개변수에 대한 참조가 더 이상 존재하지 않으면 해당 매개변수를 메서드와 호출자에서 모두 제거
  6. 필요 없어진 **this.** 제거
  7. 변수명을 적절히 변경